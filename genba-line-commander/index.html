<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾å ´LINE Commander</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-active {
      border-bottom: 3px solid #1976D2;
      color: #1976D2;
      font-weight: 600;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1976D2;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    .drop-zone {
      transition: all 0.3s ease;
    }

    .drop-zone.dragover {
      background-color: #E3F2FD;
      border-color: #1976D2;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-lg mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-2xl">ğŸ—ï¸</span>
          <div>
            <h1 class="text-lg font-bold">ç¾å ´LINE Commander</h1>
            <p class="text-xs text-blue-200">ä¸€æ–‰é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ </p>
          </div>
        </div>
        <div id="userInfo" class="text-right text-sm hidden">
          <p class="text-blue-200">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</p>
          <p id="userName" class="font-semibold"></p>
        </div>
      </div>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="max-w-lg mx-auto px-4 py-6">

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
      <nav class="flex border-b">
        <button onclick="switchTab('rain')" id="tab-rain"
                class="flex-1 py-3 text-center text-sm transition-colors tab-active">
          <span class="block text-xl mb-1">â˜”ï¸</span>
          é›¨å¤©ä¸­æ­¢
        </button>
        <button onclick="switchTab('schedule')" id="tab-schedule"
                class="flex-1 py-3 text-center text-sm text-gray-500 transition-colors hover:text-gray-700">
          <span class="block text-xl mb-1">ğŸ“…</span>
          å·¥ç¨‹å¤‰æ›´
        </button>
        <button onclick="switchTab('blueprint')" id="tab-blueprint"
                class="flex-1 py-3 text-center text-sm text-gray-500 transition-colors hover:text-gray-700">
          <span class="block text-xl mb-1">ğŸ“</span>
          å›³é¢æ›´æ–°
        </button>
      </nav>
    </div>

    <!-- å…±é€šï¼šç¾å ´é¸æŠ -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        ğŸ“ é€šçŸ¥å…ˆã®ç¾å ´
      </label>
      <select id="projectSelect"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="all">å…¨ç¾å ´ã«é€ä¿¡</option>
        <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
      </select>
      <p id="userCount" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <!-- ============================================ -->
    <!-- é›¨å¤©ä¸­æ­¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <!-- ============================================ -->
    <div id="form-rain" class="form-section">
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex items-center gap-2 mb-4 text-red-600">
          <span class="text-2xl">â˜”ï¸</span>
          <h2 class="font-bold">é›¨å¤©ä¸­æ­¢é€šçŸ¥</h2>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­æ­¢æ—¥</label>
            <input type="date" id="rain-date"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾å ´ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="rain-address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
            <p class="text-xs text-gray-500 mt-1">ğŸ“ å…¥åŠ›ã™ã‚‹ã¨é€šçŸ¥ã«ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã™</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <textarea id="rain-note" rows="2" placeholder="è¿½åŠ ã®é€£çµ¡äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
          </div>
        </div>
      </div>

      <button onclick="sendRainNotification()"
              class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-lg transition-colors flex items-center justify-center gap-2">
        <span>â˜”ï¸</span>
        <span>é›¨å¤©ä¸­æ­¢ã‚’é€ä¿¡</span>
      </button>
    </div>

    <!-- ============================================ -->
    <!-- å·¥ç¨‹å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ  -->
    <!-- ============================================ -->
    <div id="form-schedule" class="form-section hidden">
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex items-center gap-2 mb-4 text-amber-600">
          <span class="text-2xl">ğŸ“…</span>
          <h2 class="font-bold">å·¥ç¨‹å¤‰æ›´é€šçŸ¥</h2>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ—§æ—¥ç¨‹</label>
              <input type="date" id="schedule-old-date"
                     class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ–°æ—¥ç¨‹</label>
              <input type="date" id="schedule-new-date"
                     class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾å ´ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="schedule-address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
            <p class="text-xs text-gray-500 mt-1">ğŸ“ å…¥åŠ›ã™ã‚‹ã¨é€šçŸ¥ã«ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã™</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <textarea id="schedule-note" rows="2" placeholder="å¤‰æ›´ç†ç”±ãªã©ã‚’å…¥åŠ›..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
          </div>
        </div>
      </div>

      <button onclick="sendScheduleNotification()"
              class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-lg shadow-lg transition-colors flex items-center justify-center gap-2">
        <span>ğŸ“…</span>
        <span>å·¥ç¨‹å¤‰æ›´ã‚’é€ä¿¡</span>
      </button>
    </div>

    <!-- ============================================ -->
    <!-- å›³é¢æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  -->
    <!-- ============================================ -->
    <div id="form-blueprint" class="form-section hidden">
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex items-center gap-2 mb-4 text-blue-600">
          <span class="text-2xl">ğŸ“</span>
          <h2 class="font-bold">å›³é¢æ›´æ–°é€šçŸ¥</h2>
        </div>

        <div class="space-y-4">
          <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«</label>
            <div id="dropZone"
                 class="drop-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors">
              <input type="file" id="blueprint-file" accept=".pdf,.jpg,.jpeg,.png,.dwg" class="hidden">
              <div id="uploadPlaceholder">
                <span class="text-4xl block mb-2">ğŸ“</span>
                <p class="text-gray-600">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                <p class="text-xs text-gray-400 mt-1">PDF, ç”»åƒ, CADå½¢å¼ã«å¯¾å¿œ</p>
              </div>
              <div id="filePreview" class="hidden">
                <span class="text-4xl block mb-2">ğŸ“„</span>
                <p id="fileName" class="text-gray-700 font-medium truncate"></p>
                <p id="fileSize" class="text-xs text-gray-500"></p>
                <button onclick="clearFile(event)" class="text-red-500 text-sm mt-2 hover:underline">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤</button>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾å ´ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="blueprint-address" placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">ğŸ“ å…¥åŠ›ã™ã‚‹ã¨é€šçŸ¥ã«ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã™</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <textarea id="blueprint-note" rows="2" placeholder="å›³é¢ã®èª¬æ˜ãªã©ã‚’å…¥åŠ›..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
      </div>

      <button onclick="sendBlueprintNotification()"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition-colors flex items-center justify-center gap-2">
        <span>ğŸ“</span>
        <span>å›³é¢æ›´æ–°ã‚’é€ä¿¡</span>
      </button>
    </div>

  </main>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 flex flex-col items-center gap-4">
      <div class="loader"></div>
      <p id="loadingText" class="text-gray-700">é€ä¿¡ä¸­...</p>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
  <div id="toast" class="fixed top-4 left-4 right-4 max-w-lg mx-auto z-50 hidden">
    <div class="toast bg-white rounded-lg shadow-xl p-4 flex items-center gap-3">
      <span id="toastIcon" class="text-2xl"></span>
      <div class="flex-1">
        <p id="toastTitle" class="font-bold"></p>
        <p id="toastMessage" class="text-sm text-gray-600"></p>
      </div>
      <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">âœ•</button>
    </div>
  </div>

  <script>
    // ============================================
    // åˆæœŸåŒ–
    // ============================================

    const LIFF_ID = '<?= liffId ?>';
    let projects = <?= projects ?>;
    let selectedFile = null;

    // LIFFåˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          document.getElementById('userName').textContent = profile.displayName;
          document.getElementById('userInfo').classList.remove('hidden');
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’è¿½åŠ 
        populateProjects();

        // æ—¥ä»˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ˜æ—¥ã«è¨­å®š
        setDefaultDates();

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        setupFileUpload();

      } catch (error) {
        console.error('LIFF init error:', error);
        showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // ============================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    // ============================================

    function switchTab(tab) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.add('text-gray-500');
      });

      // ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
      document.querySelectorAll('.form-section').forEach(form => {
        form.classList.add('hidden');
      });

      // é¸æŠã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');

      // é¸æŠã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      document.getElementById(`form-${tab}`).classList.remove('hidden');
    }

    // ============================================
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
    // ============================================

    function populateProjects() {
      const select = document.getElementById('projectSelect');

      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.projectId;
        option.textContent = project.projectName;
        option.dataset.address = project.address || '';
        select.appendChild(option);
      });

      select.addEventListener('change', onProjectChange);
      updateUserCount();
    }

    function onProjectChange() {
      const select = document.getElementById('projectSelect');
      const selectedOption = select.options[select.selectedIndex];
      const address = selectedOption.dataset.address || '';

      // ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›
      document.getElementById('rain-address').value = address;
      document.getElementById('schedule-address').value = address;
      document.getElementById('blueprint-address').value = address;

      updateUserCount();
    }

    async function updateUserCount() {
      const projectId = document.getElementById('projectSelect').value;

      if (projectId === 'all') {
        document.getElementById('userCount').textContent = 'å…¨ã¦ã®ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã™';
        return;
      }

      try {
        const result = await callGAS('getProjectUsers', { projectId });
        if (result.success) {
          document.getElementById('userCount').textContent =
            `ã“ã®ç¾å ´ã«ã¯ ${result.data.count}äºº ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`;
        }
      } catch (error) {
        console.error('Error fetching user count:', error);
      }
    }

    // ============================================
    // æ—¥ä»˜è¨­å®š
    // ============================================

    function setDefaultDates() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];

      document.getElementById('rain-date').value = tomorrowStr;
      document.getElementById('schedule-old-date').value = tomorrowStr;

      const dayAfter = new Date();
      dayAfter.setDate(dayAfter.getDate() + 2);
      document.getElementById('schedule-new-date').value = dayAfter.toISOString().split('T')[0];
    }

    // ============================================
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    // ============================================

    function setupFileUpload() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('blueprint-file');

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      dropZone.addEventListener('click', () => fileInput.click());

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
          handleFile(e.dataTransfer.files[0]);
        }
      });
    }

    function handleFile(file) {
      // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
      if (file.size > 10 * 1024 * 1024) {
        showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        return;
      }

      selectedFile = file;

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      document.getElementById('uploadPlaceholder').classList.add('hidden');
      document.getElementById('filePreview').classList.remove('hidden');
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
    }

    function clearFile(event) {
      event.stopPropagation();
      selectedFile = null;
      document.getElementById('blueprint-file').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('filePreview').classList.add('hidden');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      const k = 1024;
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + units[i];
    }

    // ============================================
    // é€šçŸ¥é€ä¿¡
    // ============================================

    async function sendRainNotification() {
      const projectId = document.getElementById('projectSelect').value;
      const projectName = document.getElementById('projectSelect').selectedOptions[0].textContent;
      const date = document.getElementById('rain-date').value;
      const address = document.getElementById('rain-address').value;
      const note = document.getElementById('rain-note').value;

      if (!date) {
        showToast('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      showLoading('é›¨å¤©ä¸­æ­¢é€šçŸ¥ã‚’é€ä¿¡ä¸­...');

      try {
        const result = await callGAS('sendNotification', {
          type: 'rain_cancel',
          payload: {
            projectId,
            projectName,
            date,
            address,
            note
          }
        });

        hideLoading();

        if (result.success) {
          showToast('success', 'é€ä¿¡å®Œäº†', result.message);
          clearForm('rain');
        } else {
          showToast('error', 'é€ä¿¡å¤±æ•—', result.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        }
      } catch (error) {
        hideLoading();
        showToast('error', 'ã‚¨ãƒ©ãƒ¼', error.message);
      }
    }

    async function sendScheduleNotification() {
      const projectId = document.getElementById('projectSelect').value;
      const projectName = document.getElementById('projectSelect').selectedOptions[0].textContent;
      const oldDate = document.getElementById('schedule-old-date').value;
      const newDate = document.getElementById('schedule-new-date').value;
      const address = document.getElementById('schedule-address').value;
      const note = document.getElementById('schedule-note').value;

      if (!oldDate || !newDate) {
        showToast('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'æ—¥ç¨‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading('å·¥ç¨‹å¤‰æ›´é€šçŸ¥ã‚’é€ä¿¡ä¸­...');

      try {
        const result = await callGAS('sendNotification', {
          type: 'schedule_change',
          payload: {
            projectId,
            projectName,
            oldDate,
            newDate,
            address,
            note
          }
        });

        hideLoading();

        if (result.success) {
          showToast('success', 'é€ä¿¡å®Œäº†', result.message);
          clearForm('schedule');
        } else {
          showToast('error', 'é€ä¿¡å¤±æ•—', result.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        }
      } catch (error) {
        hideLoading();
        showToast('error', 'ã‚¨ãƒ©ãƒ¼', error.message);
      }
    }

    async function sendBlueprintNotification() {
      const projectId = document.getElementById('projectSelect').value;
      const projectName = document.getElementById('projectSelect').selectedOptions[0].textContent;
      const address = document.getElementById('blueprint-address').value;
      const note = document.getElementById('blueprint-note').value;

      if (!selectedFile) {
        showToast('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      showLoading('å›³é¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
        const base64Data = await fileToBase64(selectedFile);

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const uploadResult = await callGAS('uploadFile', {
          fileName: selectedFile.name,
          base64Data: base64Data,
          mimeType: selectedFile.type || 'application/octet-stream'
        });

        if (!uploadResult.success) {
          hideLoading();
          showToast('error', 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—', uploadResult.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
          return;
        }

        showLoading('å›³é¢æ›´æ–°é€šçŸ¥ã‚’é€ä¿¡ä¸­...');

        // é€šçŸ¥é€ä¿¡
        const result = await callGAS('sendNotification', {
          type: 'blueprint_update',
          payload: {
            projectId,
            projectName,
            fileName: selectedFile.name,
            fileUrl: uploadResult.data.viewUrl,
            address,
            note
          }
        });

        hideLoading();

        if (result.success) {
          showToast('success', 'é€ä¿¡å®Œäº†', result.message);
          clearForm('blueprint');
          clearFile(new Event('click'));
        } else {
          showToast('error', 'é€ä¿¡å¤±æ•—', result.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        }
      } catch (error) {
        hideLoading();
        showToast('error', 'ã‚¨ãƒ©ãƒ¼', error.message);
      }
    }

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================

    function callGAS(action, data) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .doPost({
            postData: {
              contents: JSON.stringify({ action, ...data })
            }
          });
      }).then(response => {
        // ContentServiceã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
        if (typeof response === 'string') {
          return JSON.parse(response);
        }
        return response;
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function clearForm(formType) {
      switch (formType) {
        case 'rain':
          document.getElementById('rain-note').value = '';
          break;
        case 'schedule':
          document.getElementById('schedule-note').value = '';
          break;
        case 'blueprint':
          document.getElementById('blueprint-note').value = '';
          break;
      }
    }

    // ============================================
    // UI ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    // ============================================

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(type, title, message) {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const titleEl = document.getElementById('toastTitle');
      const messageEl = document.getElementById('toastMessage');

      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };

      const colors = {
        success: 'border-l-4 border-green-500',
        error: 'border-l-4 border-red-500',
        warning: 'border-l-4 border-amber-500',
        info: 'border-l-4 border-blue-500'
      };

      icon.textContent = icons[type] || icons.info;
      titleEl.textContent = title;
      messageEl.textContent = message;

      toast.querySelector('.toast').className = `toast bg-white rounded-lg shadow-xl p-4 flex items-center gap-3 ${colors[type] || colors.info}`;
      toast.classList.remove('hidden');

      // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
      setTimeout(hideToast, 5000);
    }

    function hideToast() {
      document.getElementById('toast').classList.add('hidden');
    }
  </script>

</body>
</html>
